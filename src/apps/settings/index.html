<!doctype html>
<html class="no-js" lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Settings</title>
    <link rel="stylesheet" href="css/foundation.css" />
    <link rel="stylesheet" href="css/style.css" />
    <script src="js/vendor/modernizr.js"></script>

  </head>
  <body>
    
    <header class="grey"> <!-- Class can be "blue", "red", "grey", "orange" -->
      <section>
        <div class="app-title-container">
          <h2>Settings</h2>
        </div>
      </section>
    </header>

    <section class="container">
      <div class="row title" style="padding-bottom: 0.375rem;">
         <div class="small-12 medium-8 columns">
           <dl class="tabs" data-tab>
            <dd><a href="#panel2">Dashboard</a></dd>
            <dd><a href="#panel3">Engine</a></dd>
            <dd class="active"><a href="#panel4">Drivers</a></dd>
          </dl>
         </div>
        <div class="small-12 medium-4 columns">
          <div class="[tiny small large] button right radius" id="refresh">Refresh</div>
          <div class="[tiny small large] button right radius" id="reset">Reset</div>
        </div>
      </div>

      <div class="row" id="refresh-section" style="display:none;">
        <div class="small-12 columns center">
          <span style="text-align:center;">
            <svg class="spinner" width="40px" height="40px" viewBox="0 0 40 40" xmlns="http://www.w3.org/2000/svg">
              <circle class="path" fill="none" stroke-width="4" stroke-linecap="round" cx="20" cy="20" r="16"></circle>
            </svg>
            <h4 style="display:inline;"> Scanning ... </h4>
          </span>
        </div>
      </div>

      <div class="tabs-content">

        <div class="content" id="panel2">
          <div class="row" id="dashboard">
            <div class="small-12 large-6 columns">
               <table class="small-12">
                <thead><tr><th class="small-5">Parameter</th><th class="small-7">Value</th></tr></thead>
                <tbody class="list1"></tbody>
              </table>
            </div>
            <div class="small-12 large-6 columns">
               <table class="small-12">
                <thead><tr><th class="small-5">Parameter</th><th class="small-7">Value</th></tr></thead>
                <tbody class="list2"></tbody>
              </table>
            </div>
          </div>
        </div>

        <div class="content" id="panel3">

        </div>

        <div class="content active" id="panel4">
          <div class="row" id="Engine">
            <div class="small-12 columns">
              <table class="small-12">
                <thead><tr><th class="small-5">Parameter</th><th class="small-7">Value</th></tr></thead>
                <tbody id="engine_list"></tbody>
              </table>
            </div>
          </div>
        </div>

      </div>

       <div class="row">
        <div class="small-12 columns">
          <div class="[tiny small large] button success right radius" id="Submit">Submit</div>
        </div>
      </div>

    </section>
    
    <div id="passwdModal" class="reveal-modal" data-reveal>
      <div class="row title">
        <div class="small-12 columns">
          <h3>Network password :</h3>
        </div>
      </div>
      <div class="row">
      <div class="small-12 columns">
        <div class="row collapse">
          <div class="small-10 columns">
            <input type="password" id="netwk_passwd" required placeholder="Password">
          </div>
          <div class="small-2 columns">
            <a href="#" id="netwk_send" class="button postfix">Send</a>
          </div>
        </div>
      </div>
      </div>
    </div>

    <script src="js/vendor/jquery.js"></script>
    <script src="js/FabMo.wifi_manager.js"></script>
    <script src="js/FabMo-0.6.2.js"></script>
    <script src="js/foundation.min.js"></script>

    <script>
      var machine = dashboard.machine;

      //Load the settings of the machine
      function loadDriverSettings(machine){
        $("#engine_list").empty();

        if(machine==null) {
          dashboard.notification("error","No machine selected")
        }
        else {
          machine.get_config(function(err,config){
            if(err){console.log(err);return;}

            for(var propt in config.engine){
               var html = [
                '<tr><td>',
                  propt,
                '</td><td>',
                  '<input type="text" id="' + propt +'-label" value="' + config.engine[propt] + '">',
                '</td></tr>'
                ].join('');
                $("#engine_list").append(html);
            }
          });
        }
      };

      function loadDashboardSettings(machine) {
        var s=JSON.parse(localStorage.getItem('dashboardSettings'));

        $("#dashboard .list1").empty(); //Clean content

        for(var elt in s){

            var field = '';
            if (s[elt].type=='checkbox') {
              field='<td class="switch"><input id="' + elt + '-db-label" name="'+ s[elt].name +'" type="checkbox"' + (s[elt].value ? 'checked':'') +'><label for="' + elt + '-db-label"></label></td>';
            }
            else if (s[elt].type=='color') {
                field = '<td type="color" name="'+ s[elt].name +'" value="' +  s[elt].value + '" id="' + elt + '-db-label">';
                $.each(s[elt].colors, function( index, value ) {
                  field = field + '<div class="color item ' +(s[elt].value == value ? 'selected':'') + '" value="' +  value  + '" style="background-color:'+ value +';"></div>';
                });
                field = field + '<div class="color add"></div></td>';
            }
            else {
              field='<td><input name="'+ s[elt].name +'" type="text" id="' + elt +'-db-label" value="' + s[elt].value +'"></td>';
            }
            
            var html = [

              '<tr><td>' ,
                s[elt].name,
              '</td>',
                field,
              '</tr>'
            ].join('');

            $("#dashboard .list1").append(html);
          }

          listenColorChange();
      };


      function setting(name,value,type,colors) {
        this.name=name;
        this.value=value;
        this.type=type;
        if(colors) this.colors=colors;
      };

      function submitForms(machine) {
        //Unique submit button for all settings forms
        //Save the content of each form

        /* !!! Only implemented with dashboard Settings !!! */
        var s=new Object();
        $("#dashboard .list1 input, #dashboard .list1 td[type='color']").each(function() {
          if($(this).attr("type")=="checkbox") {
            s[$(this).attr("id").replace('-db-label','')]= new setting($(this).attr("name"),$(this).prop("checked"),$(this).attr("type"));
          }
          else if ($(this).attr("type")=="color") {
            colorList=[];
            $(this).children(".color.item").each(function(){ colorList.push($(this).attr("value")); });
            s[$(this).attr("id").replace('-db-label','')]= new setting($(this).attr("name"),$(this).attr("value"),$(this).attr("type"),colorList);
          }
          else s[$(this).attr("id").replace('-db-label','')]= new setting($(this).attr("name"),$(this).val(),$(this).attr("type"));
        });
        localStorage.setItem('dashboardSettings',JSON.stringify(s));
        dashboard.updateDashboardSettings();
        dashboard.notification("success","Settings Saved")

        //Implement Engine settings there

        //Implement Drivers settings there
      };

      function listenColorChange() {
            $("td[type='color'] div:not(.add)").click(function(){
            if(!$(this).hasClass("selected")){
              console.log("click");
              $(this).parent().children(".color.item").each(function(){ $(this).removeClass("selected"); });
              $(this).addClass("selected");
              $(this).parent().attr("value",$(this).attr("value"));
            }
          });

            $("td[type='color'] div.add").click(function(){

            });
      };

      $(document).ready(function(){
          $(document).foundation();
          loadDriverSettings(machine);
          loadDashboardSettings(machine);

          $("#refresh").click(function(){ 
            machine=dashboard.machine;
            loadDriverSettings(machine);
          });

          $("#reset").click(function() {
            dashboard.resetDashboardSettings();
            machine=dashboard.machine;
            loadDashboardSettings(machine);
          });

          $("#Submit").click(function(){
            machine=dashboard.machine;
            console.log("Click on submit button");
            submitForms(machine);
          });

          //Test code of reading a file
          /*
          $.getJSON("test.json",function(data){
            console.log(data);
          });
          */
      });
      
    </script>
  </body>